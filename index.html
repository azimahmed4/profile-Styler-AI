<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Style Snap Pro</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 40px; background: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: inline-block; width: 90%; max-width: 500px; }
        h2 { color: #1a73e8; margin-bottom: 10px; }
        #output { margin-top: 20px; border-radius: 10px; width: 100%; display: none; border: 1px solid #ddd; }
        .btn { background: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn:hover { background: #1557b0; }
        #status { margin-top: 15px; font-size: 14px; color: #555; font-weight: 500; }
        input[type="file"] { margin: 20px 0; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>‚ú® Profile Styler Pro</h2>
        <p>Apply artistic frames to your photos instantly</p>
        
        <input type="file" id="file-upload" accept="image/*">
        <button id="magic-btn" class="btn" py-click="apply_style">Generate Random Style ‚ú®</button>
        
        <div id="status">Initializing Python...</div>
        <img id="output">
        <div id="download-link-container"></div>
    </div>

    <py-config>
        packages = ["Pillow"]
    </py-config>

    <script type="py">
        from pyscript import document
        from PIL import Image, ImageOps
        import io, base64, random, js

        # Fixed Frame URLs (Using reliable raw github links)
        FRAME_URLS = [
            "https://raw.githubusercontent.com/Pravasith/Profile-Frame-API/main/frames/frame1.png",
            "https://raw.githubusercontent.com/Pravasith/Profile-Frame-API/main/frames/frame2.png",
            "https://raw.githubusercontent.com/Pravasith/Profile-Frame-API/main/frames/frame3.png"
        ]

        document.getElementById("status").innerHTML = "Ready! Upload your photo."

        async def apply_style(event):
            status = document.getElementById("status")
            file_upload = document.getElementById("file-upload")
            
            if not file_upload.files:
                status.innerHTML = "‚ö†Ô∏è Please select an image first!"
                return

            status.innerHTML = "üåÄ Processing your magic style..."
            
            try:
                # 1. Load User Image
                file = await file_upload.files.item(0).arrayBuffer()
                user_img = Image.open(io.BytesIO(file.to_bytes())).convert("RGBA")

                # 2. Pick and Fetch Random Frame
                frame_url = random.choice(FRAME_URLS)
                response = await js.fetch(frame_url)
                
                if not response.ok:
                    raise Exception("Failed to fetch frame from server.")
                
                frame_data = await response.arrayBuffer()
                frame_img = Image.open(io.BytesIO(frame_data.to_bytes())).convert("RGBA")

                # 3. Resize User Image to Frame Size
                user_img = ImageOps.fit(user_img, frame_img.size)

                # 4. Composite (Overlay frame on user image)
                final_img = Image.alpha_composite(user_img, frame_img)

                # 5. Convert to Base64 for Display
                buffered = io.BytesIO()
                final_img.save(buffered, format="PNG")
                img_base64 = base64.b64encode(buffered.getvalue()).decode()

                # Update UI
                out_img = document.getElementById("output")
                out_img.src = f"data:image/png;base64,{img_base64}"
                out_img.style.display = "block"
                status.innerHTML = "‚úÖ Style applied! Try again for a new look."
                
            except Exception as e:
                status.innerHTML = f"‚ùå Error: {str(e)}"
                print(f"Error detail: {e}")
    </script>
</body>
</html>
